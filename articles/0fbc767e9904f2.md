---
title: "Astroã§æ§‹ç¯‰ã—ãŸWEBã‚µã‚¤ãƒˆã®å·®åˆ†ç´å“ã‚’è‡ªå‹•åŒ–ã™ã‚‹"
emoji: "ğŸ·"
type: "tech"
topics: []
published: false
---

Webã‚µã‚¤ãƒˆã®é‹ç”¨ã«ãŠã„ã¦ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚„ãƒ‡ã‚¶ã‚¤ãƒ³ã®æ›´æ–°ã¯é »ç¹ã«è¡Œã‚ã‚Œã¾ã™ã€‚ç‰¹ã«å¤§è¦æ¨¡ãªã‚µã‚¤ãƒˆã‚„æ›´æ–°é »åº¦ã®é«˜ã„ã‚µã‚¤ãƒˆã§ã¯ã€æ›´æ–°ã®ãŸã³ã«å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç´å“ã™ã‚‹ã®ã¯éåŠ¹ç‡çš„ã§ã‚ã‚Šã€æ™‚é–“ã¨ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚Šã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€é™çš„ã‚µã‚¤ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã‚ã‚‹ Astro ã§æ§‹ç¯‰ã•ã‚ŒãŸã‚µã‚¤ãƒˆã®æ›´æ–°ãƒ—ãƒ­ã‚»ã‚¹ã«ãŠã„ã¦ã€å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å·®åˆ†ã¨ã—ã¦æ¤œå‡ºã—ã€è‡ªå‹•ã§ç´å“ã™ã‚‹ä»•çµ„ã¿ã‚’ AWS Lambda ã¨ GitHub Actions ã‚’ç”¨ã„ã¦å®Ÿç¾ã—ãŸäº‹ä¾‹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

### èƒŒæ™¯ã¨ç›®çš„

ç§ãŸã¡ãŒé‹ç”¨ã™ã‚‹ Astro ãƒ™ãƒ¼ã‚¹ã® Web ã‚µã‚¤ãƒˆã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ã‚„æ©Ÿèƒ½æ”¹å–„ãŒæ—¥ã€…è¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚å¾“æ¥ã¯ã€æ›´æ–°ãŒã‚ã‚‹ãŸã³ã«ã‚µã‚¤ãƒˆå…¨ä½“ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€ç”Ÿæˆã•ã‚ŒãŸå…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚„é–¢ä¿‚éƒ¨ç½²ã«ç´å“ã—ã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€ã“ã®æ–¹æ³•ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªèª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

*   **éåŠ¹ç‡æ€§**: å¤‰æ›´ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å«ã‚ã¦æ¯å›å¤§é‡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è»¢é€ãƒ»ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
*   **ç¢ºèªæ¼ã‚Œã®ãƒªã‚¹ã‚¯**: å¤‰æ›´ç®‡æ‰€ãŒåŸ‹ã‚‚ã‚Œã¦ã—ã¾ã„ã€é‡è¦ãªå¤‰æ›´ãŒè¦‹è½ã¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
*   **æ™‚é–“ã¨ã‚³ã‚¹ãƒˆ**: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚„ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€å·®åˆ†ç¢ºèªã«å¤šãã®æ™‚é–“ã¨æ‰‹é–“ãŒã‹ã‹ã‚‹ã€‚

ã“ã‚Œã‚‰ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€**å‰å›ã®ç´å“ç‰©ã¨æ¯”è¼ƒã—ã¦å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’æŠ½å‡ºã—ã€å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦è‡ªå‹•ã§ç´å“ã™ã‚‹ä»•çµ„ã¿**ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç´å“ãƒ—ãƒ­ã‚»ã‚¹ã®åŠ¹ç‡åŒ–ã¨ç¢ºå®Ÿæ€§ã®å‘ä¸Šã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

---

### ç’°å¢ƒ

ã“ã®ä»•çµ„ã¿ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã—ã¦ã„ã‚‹ä¸»ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã¨ã‚µãƒ¼ãƒ“ã‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

*   **Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: [Astro](https://astro.build/)
*   **CI/CD**: [GitHub Actions](https://github.co.jp/features/actions)
*   **å·®åˆ†æ¤œå‡ºãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°**:
    *   **åŒæœŸå¿œç­”ç”¨ Lambda**: [AWS Lambda](https://aws.amazon.com/jp/lambda/) (Node.js) - Slack ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã¸ã®å³æ™‚å¿œç­”ã¨ SQS ã¸ã®ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°æ‹…å½“
    *   **éåŒæœŸå‡¦ç†ç”¨ Lambda**: [AWS Lambda](https://aws.amazon.com/jp/lambda/) (Node.js) - å·®åˆ†æ¤œå‡ºãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°å‡¦ç†æ‹…å½“
*   **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼**: [AWS SQS](https://aws.amazon.com/jp/sqs/) - åŒæœŸ Lambda ã¨éåŒæœŸ Lambda ã®é€£æº
*   **ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãƒ»å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜**: [AWS S3](https://aws.amazon.com/jp/s3/)
*   **ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«**: [Slack](https://slack.com/) (ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹å·®åˆ†ç”Ÿæˆãƒˆãƒªã‚¬ãƒ¼ã€å®Œäº†é€šçŸ¥)

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³ï¼ˆæ¦‚å¿µï¼‰

ã“ã®å·®åˆ†ç´å“ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ä½“çš„ãªãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1.  **ã‚³ãƒ¼ãƒ‰å¤‰æ›´ & ãƒ—ãƒƒã‚·ãƒ¥ (ãƒ“ãƒ«ãƒ‰æˆæœç‰©æ›´æ–°)**:
    *   é–‹ç™ºè€…ãŒ Git ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚
    *   GitHub Actions ãŒå®Ÿè¡Œã•ã‚Œã€Astro ã‚µã‚¤ãƒˆãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã€æœ€æ–°ã®æˆæœç‰©ãŒ S3 ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚
2.  **Slack ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ (å·®åˆ†ç”ŸæˆæŒ‡ç¤º)**:
    *   ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Slack ã§ç‰¹å®šã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ (ä¾‹: `/deliverable-diff`) ã‚’å®Ÿè¡Œã—ã€å·®åˆ†ç´å“ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã‚’æŒ‡ç¤ºã—ã¾ã™ã€‚
3.  **åŒæœŸå¿œç­” Lambda**:
    *   API Gateway çµŒç”±ã§ Slack ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
    *   ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ SQS ã‚­ãƒ¥ãƒ¼ã«é€ä¿¡ã—ã¾ã™ã€‚
    *   **3 ç§’ä»¥å†…ã«** Slack ã«å³æ™‚å¿œç­”ã‚’è¿”ã—ã¾ã™ (ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå›é¿)ã€‚
4.  **SQS ã‚­ãƒ¥ãƒ¼**:
    *   åŒæœŸå¿œç­” Lambda ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸå·®åˆ†ç”Ÿæˆã‚¸ãƒ§ãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿æŒã—ã¾ã™ã€‚
5.  **éåŒæœŸå‡¦ç† Lambda**:
    *   SQS ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å·®åˆ†ç”Ÿæˆã‚¸ãƒ§ãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¾ã™ã€‚
    *   S3 ã‹ã‚‰æœ€æ–°ã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¨ã€æ¯”è¼ƒå¯¾è±¡ã¨ãªã‚‹å‰å›ã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
    *   ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¯”è¼ƒã—ã€å·®åˆ†ï¼ˆè¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’æ¤œå‡ºã—ã¾ã™ã€‚
    *   å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å«ã‚€ ZIP ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆã—ã€S3 ãƒã‚±ãƒƒãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
6.  **å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ç´å“ & Slack é€šçŸ¥**:
    *   éåŒæœŸå‡¦ç† Lambda ã¯ã€S3 ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ URL ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚
    *   Slack ã«å®Œäº†é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã€‚
7.  **(Lambda ãƒ‡ãƒ—ãƒ­ã‚¤)**:
    *   `lambda` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã€GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒ Lambda é–¢æ•°ã‚’ AWS Lambda ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

### ã‚³ãƒ¼ãƒ‰ä¾‹

ã“ã®å·®åˆ†ç´å“ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ ¸ã¨ãªã‚‹ã®ã¯ã€Slack ã‹ã‚‰ã®æŒ‡ç¤ºã‚’å—ã‘ä»˜ã‘ã‚‹åŒæœŸ Lambda ã¨ã€å®Ÿéš›ã®å·®åˆ†å‡¦ç†ã‚’è¡Œã†éåŒæœŸ Lambda ã§ã™ã€‚ã“ã“ã§ã¯ã€ãã‚Œãã‚Œã® Lambda é–¢æ•°ã®ä¸»è¦ãªå‡¦ç†ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

**1. åŒæœŸå¿œç­” Lambda**

ã“ã® Lambda é–¢æ•°ã¯ Slack ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€SQS ã«ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã—ã€Slack ã«å³æ™‚å¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚

```javascript
// lambda/diff/index.js (ä¸»è¦éƒ¨åˆ†ã®ã¿)
const { SQSClient, SendMessageCommand } = require("@aws-sdk/client-sqs");
const querystring = require('querystring');

exports.handler = async (event) => {
    // Slack ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ãƒ¼ã‚¹
    let body = event.isBase64Encoded 
        ? Buffer.from(event.body, 'base64').toString('utf8') 
        : event.body;
    const params = querystring.parse(body);
    
    // SQS ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    const messageBody = {
        command: params.command,
        text: params.text,
        response_url: params.response_url,
        triggered_user: params.user_name,
    };
    
    try {
        // SQS ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        await sqsClient.send(new SendMessageCommand({
            QueueUrl: process.env.SQS_QUEUE_URL,
            MessageBody: JSON.stringify(messageBody)
        }));
        
        // Slack ã«å³æ™‚å¿œç­”ã‚’è¿”ã™ (3ç§’ä»¥å†…)
        return {
            statusCode: 200,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                response_type: 'ephemeral',
                text: 'å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚å®Œäº†ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚ :hourglass_flowing_sand:',
            }),
        };
    } catch (error) {
        console.error("Error:", error);
        return {
            statusCode: 500,
            body: JSON.stringify({
                response_type: 'ephemeral',
                text: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
            }),
        };
    }
};
```

**2. éåŒæœŸå‡¦ç† Lambda**

ã“ã® Lambda é–¢æ•°ã¯ã€å®Ÿéš›ã®å·®åˆ†æ¯”è¼ƒå‡¦ç†ã‚„ ZIP ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆã€S3 ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€Slack ã¸ã®é€šçŸ¥ã‚’è¡Œã„ã¾ã™ã€‚å‡¦ç†ã®å¤§ã¾ã‹ãªæµã‚Œã‚’ç¤ºã—ã¾ã™ã€‚

```javascript
// lambda/async/index.js (å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®æ¦‚è¦)
exports.handler = async (event) => {
    for (const record of event.Records) {
        const messageBody = JSON.parse(record.body);
        const responseUrl = messageBody.response_url;
        
        // ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        const tempDir = await fs.mkdtemp(path.join(os.tmpdir(), 'diff-'));
        const currentDir = path.join(tempDir, 'current');
        const previousDir = path.join(tempDir, 'previous');
        
        try {
            // 1. S3ã‹ã‚‰ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            await downloadFromS3(buildBucket, 'builds/latest', currentDir);
            await downloadFromS3(buildBucket, 'builds/previous_stable', previousDir);
            
            // 2. ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä½œæˆã¨ãƒãƒƒã‚·ãƒ¥æ¯”è¼ƒ
            const currentManifest = await getFileManifest(currentDir);
            const previousManifest = await getFileManifest(previousDir);
            const diffResult = compareManifests(previousManifest, currentManifest);
            
            const filesToZip = [...diffResult.added, ...diffResult.modified];
            
            if (filesToZip.length === 0 && diffResult.deleted.length === 0) {
                // å¤‰æ›´ãŒãªã„å ´åˆã®é€šçŸ¥
                await sendSlackNotification(responseUrl, `å·®åˆ†ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
            } else {
                // 3. å·®åˆ†ZIPãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã¨S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const zipFileName = `deliverable_diff_${timestamp}.zip`;
                const s3ZipKey = await createAndUploadZip(
                    filesToZip, 
                    currentDir, 
                    zipFileName, 
                    deliverableBucket, 
                    'deliverables'
                );
                
                // 4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã®ç”Ÿæˆã¨Slacké€šçŸ¥
                const downloadUrl = `https://s3.${process.env.AWS_REGION}.amazonaws.com/${deliverableBucket}/${s3ZipKey}`;
                
                let slackMessage = `å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒã§ãã¾ã—ãŸï¼ :tada:\n`;
                slackMessage += `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: ${downloadUrl}\n`;
                slackMessage += `è¿½åŠ : ${diffResult.added.length}ä»¶\n`;
                slackMessage += `å¤‰æ›´: ${diffResult.modified.length}ä»¶\n`;
                slackMessage += `å‰Šé™¤: ${diffResult.deleted.length}ä»¶\n`;
                
                await sendSlackNotification(responseUrl, slackMessage);
            }
        } catch (error) {
            // ã‚¨ãƒ©ãƒ¼é€šçŸ¥
            await sendSlackNotification(responseUrl, 
                `å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            throw error;
        } finally {
            // ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            await fs.rm(tempDir, { recursive: true, force: true });
        }
    }
};
```

**3. ä¸»è¦ãªå‡¦ç†é–¢æ•°**

éåŒæœŸ Lambda ã§ä½¿ç”¨ã•ã‚Œã‚‹ä¸»è¦ãªå‡¦ç†é–¢æ•°ã®æ¦‚è¦ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

```javascript
// S3ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
async function downloadFromS3(bucket, prefix, targetDir) {
    // S3ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
}

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã¨ãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—
async function getFileManifest(dir) {
    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€ãƒ‘ã‚¹ã¨ãƒãƒƒã‚·ãƒ¥å€¤ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
}

// æ—§ç‰ˆã¨æ–°ç‰ˆã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ¯”è¼ƒã—å·®åˆ†ã‚’å–å¾—
function compareManifests(oldManifest, newManifest) {
    // è¿½åŠ ã€å¤‰æ›´ã€å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
}

// å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ ZIP ã‚’ä½œæˆã—ã¦ S3 ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
async function createAndUploadZip(filesToInclude, sourceDir, zipFileName, bucket, prefix) {
    // ZIPã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆã—ã€S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
}

// Slack ã«é€šçŸ¥ã‚’é€ä¿¡
async function sendSlackNotification(webhookUrl, message) {
    // HTTP POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§Slackã«é€šçŸ¥
}
```

**4. å‰ææ¡ä»¶ã¨è¨­å®š**

Lambda é–¢æ•°ã«ã¯é©åˆ‡ãª IAM æ¨©é™ã®è¨­å®šã‚„ä»¥ä¸‹ã®ã‚ˆã†ãªç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ã§ã™ã€‚

```
AWS_REGION=ap-northeast-1
SQS_QUEUE_URL=https://sqs.ap-northeast-1.amazonaws.com/123456789012/diff-jobs
BUILD_BUCKET_NAME=my-astro-builds
DELIVERABLE_BUCKET_NAME=my-deliverables
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/XXXXX/YYYYY/ZZZZZ
```

ã¾ãŸã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®æº–å‚™ãŒå¿…è¦ã§ã™ã€‚

* Slack App ã®è¨­å®šï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®ç™»éŒ²ï¼‰
* API Gateway ã®è¨­å®šï¼ˆSlack ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ï¼‰
* SQS ã‚­ãƒ¥ãƒ¼ã®ä½œæˆï¼ˆLambda é–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰
* S3 ãƒã‚±ãƒƒãƒˆã®æº–å‚™ï¼ˆãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¨å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ï¼‰
* Lambda é–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤

### å®Ÿè¡Œä¾‹

ã“ã®å·®åˆ†ç´å“ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

1.  **ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®æ›´æ–°**: ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚„ CMS æ›´æ–°ã«ã‚ˆã‚Šã€GitHub Actions ãŒå®Ÿè¡Œã•ã‚Œã€æœ€æ–°ã®ã‚µã‚¤ãƒˆãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œ S3 ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚

2.  **å·®åˆ†ç”Ÿæˆã®æŒ‡ç¤º**: é‹ç”¨æ‹…å½“è€…ãŒ Slack ã‹ã‚‰å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
    ```
    /deliverable-diff compare_with=previous_stable
    ```

3.  **å³æ™‚å¿œç­”**: åŒæœŸ Lambda ãŒå³åº§ã«å¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚
    ```
    å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚å®Œäº†ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚ :hourglass_flowing_sand:
    ```

4.  **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†**: éåŒæœŸ Lambda ãŒå·®åˆ†ã‚’æ¤œå‡ºã—ã€ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã— S3 ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

5.  **å®Œäº†é€šçŸ¥**: å‡¦ç†å®Œäº†å¾Œã€Slack ã«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚
    ```
    å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒã§ãã¾ã—ãŸï¼ :tada:
    ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: https://my-deliverables.s3.ap-northeast-1.amazonaws.com/deliverables/deliverable_diff_2023-10-27T10-30-00Z.zip
    è¿½åŠ : 5ä»¶
    å¤‰æ›´: 12ä»¶
    å‰Šé™¤: 2ä»¶
    ```

6.  **ç¢ºèª**: é–¢ä¿‚è€…ã¯é€šçŸ¥ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¾ã™ã€‚

ã“ã®ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å·®åˆ†å‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤ã“ã¨ãªãã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‡¦ç†ãŒé€²è¡Œã—ã€å®Œäº†å¾Œã«é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ã¾ã¨ã‚ã¨åŠ¹æœ

AWS Lambda ã¨ GitHub Actions ã‚’æ´»ç”¨ã—ãŸå·®åˆ†ç´å“ã®è‡ªå‹•åŒ–ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ãªåŠ¹æœã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

* **åŠ¹ç‡åŒ–**: ç´å“ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãŒå¹³å‡ã§ **90%ä»¥ä¸Šå‰Šæ¸›**ï¼ˆå…¨ãƒ•ã‚¡ã‚¤ãƒ«ç´„100MBã‹ã‚‰å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ç´„5-10MBç¨‹åº¦ã«ï¼‰
* **æ™‚é–“çŸ­ç¸®**: ç´å“ã‹ã‚‰ç¢ºèªå®Œäº†ã¾ã§ã®æ™‚é–“ãŒ **ç´„60åˆ†ã‹ã‚‰ç´„10åˆ†ã«çŸ­ç¸®**
* **ç²¾åº¦å‘ä¸Š**: å¤‰æ›´ç®‡æ‰€ã®æŠŠæ¡ãŒå®¹æ˜“ã«ãªã‚Šã€ç¢ºèªæ¼ã‚Œã®ãƒªã‚¹ã‚¯ãŒå¤§å¹…ã«ä½æ¸›
* **é‹ç”¨è² è·è»½æ¸›**: æ‰‹å‹•ã§ã®å·®åˆ†æŠ½å‡ºä½œæ¥­ãŒä¸è¦ã«ãªã‚Šã€é–‹ç™ºãƒªã‚½ãƒ¼ã‚¹ã‚’æœ¬æ¥ã®æ¥­å‹™ã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«

ä»Šå¾Œã®å±•æœ›ã¨ã—ã¦ã¯ã€å·®åˆ†æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ã®ã•ã‚‰ãªã‚‹æœ€é©åŒ–ã‚„ã€ç´å“å…ˆã«å¿œã˜ãŸæŸ”è»Ÿãªè¨­å®šå¤‰æ›´æ©Ÿèƒ½ã®è¿½åŠ ãªã©ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚Webã‚µã‚¤ãƒˆé‹ç”¨ã®åŠ¹ç‡åŒ–ã‚’ç›®æŒ‡ã™ä¸Šã§ã€ã“ã®ã‚ˆã†ãªè‡ªå‹•åŒ–ã®å–ã‚Šçµ„ã¿ã¯éå¸¸ã«æœ‰åŠ¹ãªæ‰‹æ®µã®ä¸€ã¤ã¨è¨€ãˆã‚‹ã§ã—ã‚‡ã†ã€‚